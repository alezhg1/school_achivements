{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
/* –°—Ç–∏–ª–∏ –∏–∑ student_report + –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ */
.class-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    padding: 30px;
}

.progress-bar {
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    height: 20px;
    margin: 10px 0;
}

.progress-fill {
    background: linear-gradient(135deg, #28a745, #20c997);
    height: 100%;
    transition: width 0.3s ease;
}

.student-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin: 10px 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border-left: 4px solid #007bff;
}

.student-rank {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
    background: #007bff;
    color: white;
    border-radius: 50%;
    font-weight: bold;
    margin-right: 15px;
}

.top-students {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
    margin: 20px 0;
}
</style>
{% endblock %}

{% block content %}
<div class="report-container">
    <div class="report-header">
        <h1 class="report-title">üè´ –û—Ç—á–µ—Ç –ø–æ –∫–ª–∞—Å—Å—É</h1>
        <p class="report-subtitle">{{ classroom.name }} ‚Ä¢ –£—á–∏—Ç–µ–ª—å: {{ classroom.teacher.get_full_name|default:classroom.teacher.username }}</p>
    </div>

    <div class="class-stats">
        <div class="info-card">
            <div class="info-label">–í—Å–µ–≥–æ —É—á–µ–Ω–∏–∫–æ–≤</div>
            <div class="info-value">{{ stats.total_students }}</div>
        </div>
        <div class="info-card">
            <div class="info-label">–í—Å–µ–≥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>
            <div class="info-value">{{ stats.total_achievements }}</div>
        </div>
        <div class="info-card">
            <div class="info-label">–°—Ä–µ–¥–Ω–µ–µ –Ω–∞ —É—á–µ–Ω–∏–∫–∞</div>
            <div class="info-value">{{ stats.avg_per_student }}</div>
        </div>
        <div class="info-card">
            <div class="info-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —É—á–µ–Ω–∏–∫–æ–≤</div>
            <div class="info-value">{{ stats.active_percentage }}%</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ stats.active_percentage }}%"></div>
            </div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>üèÜ –¢–æ–ø —É—á–µ–Ω–∏–∫–æ–≤</h3>
            {% if stats.top_students %}
                <div class="top-students">
                    {% for student in stats.top_students %}
                    <div class="student-card">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <div class="student-rank">{{ forloop.counter }}</div>
                            <div>
                                <strong>{{ student.get_full_name|default:student.username }}</strong>
                                <br>
                                <small style="color: #666;">
                                    {{ student.achievement_count }} –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="icon">üë•</div>
                    <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± —É—á–µ–Ω–∏–∫–∞—Ö</p>
                </div>
            {% endif %}
        </div>

        <div class="stat-card">
            <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h3>
            {% if stats.result_stats %}
                {% for result in stats.result_stats %}
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                    <span>{{ result.result }}</span>
                    <strong>{{ result.count }}</strong>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="icon">üìà</div>
                    <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div style="padding: 30px;">
        <h3 style="margin: 0 0 20px 0; color: #003366;">üë• –°–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤</h3>
        {% if students %}
            <table class="achievements-table">
                <thead>
                    <tr>
                        <th>–£—á–µ–Ω–∏–∫</th>
                        <th>–ö–ª–∞—Å—Å</th>
                        <th>–î–æ—Å—Ç–∏–∂–µ–Ω–∏–π</th>
                        <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td>
                            <strong>{{ student.get_full_name|default:student.username }}</strong>
                        </td>
                        <td>
                            {% if student.class_number and student.class_letter %}
                                {{ student.class_number }}{{ student.class_letter }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge {% if student.achievement_count > 0 %}badge-success{% else %}badge-secondary{% endif %}">
                                {{ student.achievement_count }}
                            </span>
                        </td>
                        <td>{{ student.date_joined|date:"d.m.Y" }}</td>
                        <td>
                            {% if student.achievement_count > 0 %}
                                <span class="badge badge-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                            {% else %}
                                <span class="badge badge-warning">–ù–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="empty-state">
                <div class="icon">üë•</div>
                <h3>–í –∫–ª–∞—Å—Å–µ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤</h3>
                <p>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ —É—á–µ–Ω–∏–∫–æ–≤ –≤ —ç—Ç–æ—Ç –∫–ª–∞—Å—Å</p>
            </div>
        {% endif %}
    </div>

    <div class="export-buttons">
        <a href="{% url 'myadmin:export_classroom_csv' classroom.id %}" class="btn btn-success">
            üì• –°–∫–∞—á–∞—Ç—å CSV –æ—Ç—á–µ—Ç
        </a>
        <a href="/admin/accounts/classroom/" class="btn btn-primary">
            ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –∫–ª–∞—Å—Å–æ–≤
        </a>
    </div>
</div>
{% endblock %}